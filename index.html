<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<style>
body{background:#111;color:#fff;text-align:center;font-family:sans-serif}
input,button{padding:8px;margin:4px}
#chat{border:1px solid #555;height:150px;overflow:auto;margin:10px}
#alert{color:yellow;font-size:20px;margin:10px}
</style>
</head>
<body>

<h1>üé≤ ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>

<div id="alert"></div>

<input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏∂‡∏á">
<input id="room" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á">
<input id="roomPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
<br>
<button onclick="createRoom()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
<button onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>

<div id="game" style="display:none">
  <h2 id="roomTitle"></h2>

  <input id="guess" type="number" placeholder="‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 1-100">
  <button onclick="guessNum()">‡πÄ‡∏î‡∏≤</button>
  <p id="result"></p>

  <h3>üí¨ ‡πÅ‡∏ä‡∏ó</h3>
  <div id="chat"></div>
  <input id="msg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ä‡∏ó">
  <button onclick="sendMsg()">‡∏™‡πà‡∏á</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, push, onValue, remove } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDRlB6q1NJeSnO4JsLQcUHr28XGKo573sk",
  authDomain: "peem-dc962.firebaseapp.com",
  databaseURL: "https://peem-dc962-default-rtdb.firebaseio.com",
  projectId: "peem-dc962",
  storageBucket: "peem-dc962.firebasestorage.app",
  messagingSenderId: "1021248731842",
  appId: "1:1021248731842:web:0e8b4ec8e0f51e0578595b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// =================== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å ===================
let currentRoom = "";
let answer = 0;

const nameVal = () => document.getElementById("name").value.trim();
const roomVal = () => document.getElementById("room").value.trim();
const passVal = () => document.getElementById("roomPass").value.trim();

// =================== ‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á ===================
window.createRoom = async () => {
  if(!nameVal() || !roomVal())
    return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏¥‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢");

  answer = Math.floor(Math.random()*100)+1;

  await set(ref(db,"rooms/"+roomVal()),{
    host:nameVal(),
    password:passVal(),
    answer
  });

  enterRoom();
};

window.joinRoom = async () => {
  const snap = await get(ref(db,"rooms/"+roomVal()));
  if(!snap.exists()) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™");

  if(snap.val().password && snap.val().password !== passVal())
    return alert("‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏¥‡∏î");

  answer = snap.val().answer;
  enterRoom();
};

function enterRoom(){
  currentRoom = roomVal();
  game.style.display = "block";
  roomTitle.innerText = "‡∏´‡πâ‡∏≠‡∏á " + currentRoom;

  onValue(ref(db,"rooms/"+currentRoom+"/chat"), s=>{
    chat.innerHTML="";
    s.forEach(c=>{
      chat.innerHTML += `<div>${c.val().name}: ${c.val().text}</div>`;
    });
  });
}

// =================== ‡πÄ‡∏Å‡∏° ===================
window.guessNum = ()=>{
  const g = Number(guess.value);
  if(!g) return;

  if(g > answer) result.innerText = "‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ß‡∏∞";
  else if(g < answer) result.innerText = "‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢";
  else result.innerText = "‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™ üéâ";
};

// =================== ‡πÅ‡∏ä‡∏ó ===================
window.sendMsg = ()=>{
  if(!msg.value) return;
  push(ref(db,"rooms/"+currentRoom+"/chat"),{
    name:nameVal(),
    text:msg.value
  });
  msg.value="";
};

// =================== ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ===================
const RESET_INTERVAL = 30 * 60 * 1000; // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
const WARNING_TIME  = 5  * 60 * 1000; // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ

async function autoResetServer(){
  const now = Date.now();
  const resetRef = ref(db,"lastReset");
  const warnRef  = ref(db,"warned");

  const snap = await get(resetRef);

  if(!snap.exists()){
    await set(resetRef, now);
    await set(warnRef, false);
    return;
  }

  const diff = now - snap.val();

  if(diff >= RESET_INTERVAL - WARNING_TIME){
    const w = await get(warnRef);
    if(!w.val()) await set(warnRef,true);
  }

  if(diff >= RESET_INTERVAL){
    await remove(ref(db,"rooms"));
    await set(resetRef, now);
    await set(warnRef,false);
    alert.innerText = "üí• ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢";
  }
}

onValue(ref(db,"warned"), s=>{
  if(s.val()){
    alert.innerText = "‚ö†Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡∏à‡∏∞‡∏£‡∏µ‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏£‡∏µ‡∏ö‡πÄ‡∏•‡πà‡∏ô‡∏ã‡∏∞‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™";
  } else {
    alert.innerText = "";
  }
});

autoResetServer();
</script>

</body>
</html>
