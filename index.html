<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹€à¸à¸¡à¸—à¸²à¸¢à¸•à¸±à¸§à¹€à¸¥à¸‚à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ</title>

<style>
body{background:#111;color:#fff;text-align:center;font-family:sans-serif;margin-top:20px}
input,button{padding:10px;font-size:16px;margin:4px}
#result{margin:10px;font-size:18px}
.good{color:#4caf50}.bad{color:#f44336}
#log,#chatBox{max-width:420px;margin:10px auto;background:#222;padding:10px;text-align:left;border:1px solid #444}
#chatBox{height:160px;overflow-y:auto}
table{margin:auto;border-collapse:collapse}
td,th{border:1px solid #555;padding:6px 12px}
</style>
</head>

<body>

<h1>ğŸ² à¹€à¸à¸¡à¸—à¸²à¸¢à¸•à¸±à¸§à¹€à¸¥à¸‚à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ</h1>

<input id="name" placeholder="à¸Šà¸·à¹ˆà¸­à¸¡à¸¶à¸‡"><br>
<input id="room" placeholder="à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡"><br>
<input id="roomPass" placeholder="à¸£à¸«à¸±à¸ªà¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡"><br>

<button onclick="createRoom()">à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡</button>
<button onclick="resetRound()">à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸­à¸š (Host)</button>
<button onclick="resetServer()">à¸£à¸µà¹€à¸‹à¹‡à¸•à¸«à¹‰à¸­à¸‡ (à¹à¸­à¸”à¸¡à¸´à¸™)</button>

<hr>

<input type="number" id="guess" placeholder="à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹€à¸”à¸²"><br>
<button onclick="check()">à¹€à¸”à¸²à¹€à¸¥à¸¢à¹„à¸­à¹‰à¸ªà¸±à¸ª</button>

<div id="result"></div>

<div id="log"><b>ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´</b></div>

<h2>ğŸ† à¸•à¸²à¸£à¸²à¸‡à¸„à¸°à¹à¸™à¸™</h2>
<table>
<thead><tr><th>#</th><th>à¸Šà¸·à¹ˆà¸­</th><th>à¹à¸•à¹‰à¸¡</th></tr></thead>
<tbody id="leaderboard"></tbody>
</table>

<h2>ğŸ’¬ à¹à¸Šà¸—</h2>
<div id="chatBox"></div>
<input id="chatInput" placeholder="à¸à¸´à¸¡à¸à¹Œà¸„à¸¸à¸¢">
<button onclick="sendChat()">à¸ªà¹ˆà¸‡</button>

<audio id="soundCorrect" src="https://www.soundjay.com/buttons/sounds/button-4.mp3"></audio>
<audio id="soundWrong" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, update, remove, onValue, push } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDRlB6q1NJeSnO4JsLQcUHr28XGKo573sk",
  authDomain: "peem-dc962.firebaseapp.com",
  databaseURL: "https://peem-dc962-default-rtdb.firebaseio.com",
  projectId: "peem-dc962",
  storageBucket: "peem-dc962.firebasestorage.app",
  messagingSenderId: "1021248731842",
  appId: "1:1021248731842:web:0e8b4ec8e0f51e0578595b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PASSWORD = "1234";

/* ğŸ”§ à¹à¸à¹‰à¸šà¸±à¹Šà¸à¸•à¸±à¸§à¹à¸›à¸£ input */
const nameVal = () => document.getElementById("name").value.trim();
const roomVal = () => document.getElementById("room").value.trim();
const passVal = () => document.getElementById("roomPass").value.trim();
const roomPath = r => `rooms/${r}`;

async function checkRoom(room){
  const s = await get(ref(db, roomPath(room)));
  return s.exists() && s.val().password === passVal();
}
async function isHost(room,name){
  const s = await get(ref(db, roomPath(room)));
  return s.exists() && s.val().host === name;
}

window.createRoom = async () => {
  if(!nameVal() || !passVal()) return alert("à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸à¸±à¸šà¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸à¹ˆà¸­à¸™à¸”à¸´à¹„à¸­à¹‰à¹€à¸«à¸µà¹‰à¸¢");
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  document.getElementById("room").value = code;

  await set(ref(db, roomPath(code)),{
    host:nameVal(),
    password:passVal(),
    answer:Math.floor(Math.random()*100)+1,
    scores:{},log:{},chat:{}
  });

  const link = `${location.origin}${location.pathname}?room=${code}`;
  result.innerHTML = `à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡ <b>${code}</b><br>Host: <b>${nameVal()}</b><br>
  à¸¥à¸´à¸‡à¸à¹Œà¹€à¸Šà¸´à¸:<br><a href="${link}" target="_blank">${link}</a>`;
};

window.check = async () => {
  const r=roomVal(), n=nameVal(), g=guess.value;
  if(!r||!n||!g) return;
  if(!(await checkRoom(r))) return result.innerText="à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸œà¸´à¸” à¹„à¸ªà¸«à¸±à¸§à¹„à¸›";

  const s = await get(ref(db, roomPath(r)));
  const ans = s.val().answer;

  if(g==ans){
    soundCorrect.play();
    result.innerHTML=`<span class="good">ğŸ‰ ${n} à¸–à¸¹à¸ (${g})</span>`;
    const sr=ref(db,`${roomPath(r)}/scores/${n}`);
    const sv=await get(sr); await set(sr, sv.exists()?sv.val()+1:1);
    await push(ref(db,`${roomPath(r)}/log`),`ğŸ‰ ${n} à¸–à¸¹à¸ (${g})`);
    await update(ref(db,roomPath(r)),{answer:Math.floor(Math.random()*100)+1,log:{}});
  }else if(g<ans){
    soundWrong.play(); result.innerText="à¸™à¹‰à¸­à¸¢à¹„à¸›à¸§à¸°";
    await push(ref(db,`${roomPath(r)}/log`),`âŒ ${n} à¹€à¸”à¸² ${g} (à¸™à¹‰à¸­à¸¢à¹„à¸›)`);
  }else{
    soundWrong.play(); result.innerText="à¸¡à¸²à¸à¹„à¸›à¹„à¸­à¹‰à¸ªà¸±à¸ª";
    await push(ref(db,`${roomPath(r)}/log`),`âŒ ${n} à¹€à¸”à¸² ${g} (à¸¡à¸²à¸à¹„à¸›)`);
  }
  guess.value="";
};

window.resetRound = async () => {
  const r=roomVal(), n=nameVal();
  if(!(await checkRoom(r))) return alert("à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸œà¸´à¸”");
  if(!(await isHost(r,n))) return alert("à¸¡à¸¶à¸‡à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Host à¸£à¸µà¹„à¸¡à¹ˆà¹„à¸”à¹‰");
  await update(ref(db,roomPath(r)),{answer:Math.floor(Math.random()*100)+1,log:{}});
  await push(ref(db,`${roomPath(r)}/log`),`ğŸ‘‘ ${n} à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸­à¸š`);
};

window.sendChat = async () => {
  const r=roomVal(), n=nameVal(), msg=chatInput.value;
  if(!msg) return;
  if(!(await checkRoom(r))) return alert("à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸œà¸´à¸”");
  await push(ref(db,`${roomPath(r)}/chat`),{name:n,text:msg});
  chatInput.value="";
};

window.resetServer = async () => {
  const r=roomVal();
  if(prompt("à¸£à¸«à¸±à¸ªà¹à¸­à¸”à¸¡à¸´à¸™")!==ADMIN_PASSWORD) return alert("à¸£à¸«à¸±à¸ªà¸œà¸´à¸”à¹„à¸­à¹‰à¹€à¸«à¸µà¹‰à¸¢");
  await remove(ref(db,roomPath(r)));
  result.innerText="ğŸ’£ à¸¥à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹à¸¥à¹‰à¸§";
};

onValue(ref(db),snap=>{
  const r=roomVal(); const d=snap.child(roomPath(r)).val(); if(!d) return;
  log.innerHTML="<b>ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´</b>";
  d.log && Object.values(d.log).slice(-6).forEach(t=>log.innerHTML+=`<div>- ${t}</div>`);
  leaderboard.innerHTML="";
  d.scores && Object.entries(d.scores).sort((a,b)=>b[1]-a[1])
  .forEach((v,i)=>leaderboard.innerHTML+=`<tr><td>${i+1}</td><td>${v[0]}</td><td>${v[1]}</td></tr>`);
  chatBox.innerHTML="";
  d.chat && Object.values(d.chat).slice(-20)
  .forEach(c=>chatBox.innerHTML+=`<div><b>${c.name}:</b> ${c.text}</div>`);
});
</script>

</body>
</html>
